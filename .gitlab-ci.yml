stages:
  - validate
  - infrastructure
  - deploy
  - test
  - destroy

variables:
  CLUSTER_NAME: "axual-demo-cluster"
  AWS_REGION: "us-east-1"
  MYSQL_ROOT_PASSWORD: "DemoPassword123!"
  MYSQL_DATABASE: "test"
  MYSQL_USER: "test"
  MYSQL_PASSWORD: "test123"

image: alpine:latest

.setup_tools: &setup_tools |
  apk add --no-cache python3 py3-pip curl wget unzip bash ca-certificates
  pip3 install awscli --break-system-packages
  curl -LO "https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl"
  chmod +x kubectl && mv kubectl /usr/local/bin/
  curl -LO "https://get.helm.sh/helm-v3.17.0-linux-amd64.tar.gz"
  tar -zxvf helm-v3.17.0-linux-amd64.tar.gz && mv linux-amd64/helm /usr/local/bin/
  aws configure set aws_access_key_id ${AWS_ACCESS_KEY_ID}
  aws configure set aws_secret_access_key ${AWS_SECRET_ACCESS_KEY}
  aws configure set region ${AWS_REGION}

.setup_terraform: &setup_terraform |
  wget -O terraform.zip "https://releases.hashicorp.com/terraform/1.13.5/terraform_1.13.5_linux_amd64.zip"
  unzip -o terraform.zip -d /usr/local/bin/
  chmod +x /usr/local/bin/terraform

validate_terraform:
  stage: validate
  when: manual
  before_script:
    - *setup_tools
    - *setup_terraform
  script:
    - cd terraform
    - terraform init
    - terraform validate
    - terraform plan -out=plan.tfplan
  artifacts:
    paths:
      - terraform/plan.tfplan
    expire_in: 1 hour
  only:
    - main
    - merge_requests

deploy_infrastructure:
  stage: infrastructure
  when: manual
  before_script:
    - *setup_tools
    - *setup_terraform
  script:
    - cd terraform
    - terraform init
    - terraform apply -input=false plan.tfplan
    - aws eks wait cluster-active --name ${CLUSTER_NAME} --region ${AWS_REGION}
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME}
    - kubectl get nodes
  dependencies:
    - validate_terraform
  only:
    - main

deploy_prerequisites:
  stage: deploy
  when: manual
  before_script:
    - *setup_tools
  script:
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME}
    - helm repo add eks https://aws.github.io/eks-charts
    - helm repo add aws-ebs-csi-driver https://kubernetes-sigs.github.io/aws-ebs-csi-driver
    - helm repo update
    - EBS_ROLE_ARN=$(aws iam get-role --role-name "${CLUSTER_NAME}-ebs-csi-driver" --query 'Role.Arn' --output text)
    - ALB_ROLE_ARN=$(aws iam get-role --role-name "${CLUSTER_NAME}-alb-controller-role" --query 'Role.Arn' --output text)
    - |
      helm upgrade --install aws-ebs-csi-driver aws-ebs-csi-driver/aws-ebs-csi-driver \
        --namespace kube-system \
        --set controller.serviceAccount.create=true \
        --set controller.serviceAccount.annotations."eks\.amazonaws\.com/role-arn"="$EBS_ROLE_ARN" \
        --wait --timeout 5m
    - kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=aws-ebs-csi-driver -n kube-system --timeout=300s
    - kubectl apply -f helm/gp3-sc.yaml
    - |
      helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
        --namespace kube-system \
        --set clusterName=${CLUSTER_NAME} \
        --set region=${AWS_REGION} \
        --set serviceAccount.create=true \
        --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"="$ALB_ROLE_ARN" \
        --wait --timeout 5m
    - kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=aws-load-balancer-controller -n kube-system --timeout=300s
  dependencies:
    - deploy_infrastructure
  only:
    - main

deploy_mysql:
  stage: deploy
  when: manual
  before_script:
    - *setup_tools
  script:
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME}
    - kubectl create namespace mysql --dry-run=client -o yaml | kubectl apply -f -
    - helm repo add bitnami https://charts.bitnami.com/bitnami
    - helm repo update
    - |
      helm upgrade --install mysql bitnami/mysql \
        --namespace mysql \
        --values helm/mysql-values.yaml \
        --set auth.rootPassword="${MYSQL_ROOT_PASSWORD}" \
        --set auth.database="${MYSQL_DATABASE}" \
        --set auth.username="${MYSQL_USER}" \
        --set auth.password="${MYSQL_PASSWORD}" \
        --wait --timeout=5m
    - kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=mysql -n mysql --timeout=300s
  dependencies:
    - deploy_prerequisites
  only:
    - main

deploy_app:
  stage: deploy
  before_script:
    - *setup_tools
  script:
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME}
    - kubectl create namespace myapp --dry-run=client -o yaml | kubectl apply -f -
    - helm upgrade --install myapp ./helm --namespace myapp --set service.type=LoadBalancer --wait --timeout=5m
    - kubectl wait --for=condition=ready pod -l app=my-app -n myapp --timeout=300s
  dependencies:
    - deploy_mysql
  only:
    - main

smoke_tests:
  stage: test
  before_script:
    - *setup_tools
  script:
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME}
    - kubectl get pods -n mysql
    - kubectl get pods -n myapp
    - kubectl get pvc -A
    - kubectl get svc -A
  dependencies:
    - deploy_app
  only:
    - main

cleanup_k8s_resources:
  stage: destroy
  when: manual
  before_script:
    - *setup_tools
  script:
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${CLUSTER_NAME} || true
    - helm uninstall myapp -n myapp || true
    - helm uninstall mysql -n mysql || true
    - helm uninstall aws-load-balancer-controller -n kube-system || true
    - helm uninstall aws-ebs-csi-driver -n kube-system || true
    - kubectl delete namespace myapp || true
    - kubectl delete namespace mysql || true
    - kubectl delete sc gp3 || true
    - echo "Waiting for LoadBalancers to be deleted..."
    - sleep 60
    - kubectl get svc -A
  only:
    - main

destroy_infrastructure:
  stage: destroy
  when: manual
  before_script:
    - *setup_tools
    - *setup_terraform
  script:
    - cd terraform
    - terraform init
    - terraform destroy -auto-approve
    - echo "All AWS resources destroyed!"
  dependencies:
    - cleanup_k8s_resources
  only:
    - main